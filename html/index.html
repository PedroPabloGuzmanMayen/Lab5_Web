<!DOCTYPE html>
<html>
    <head>
        <title>Chat</title>
    </head>
    <body>
        <script type="application/javascript">
            //Con estas variables guardaremos el usuario y el mensaje
            console.log('Hola '.length)
            let user = ''
            let message1 = ''
            //Le damos estilo a la lista de mensajes
            const messagesList = document.createElement('ul')
            messagesList.style.position = 'fixed'
            messagesList.style.bottom = '200px'
            messagesList.style.left = '50%'
            messagesList.style.transform = 'translateX(-50%)';
            messagesList.style.height = '300px'
            messagesList.style.overflowY = 'scroll'
            messagesList.style.width = '80%'
            //Esta función nos ayudará a obtener los mensajes de la API
            const getMessages = async () =>{
                const response = await fetch('https://chat.tiburoncin.lat/messages')
                const messages = await response.json()
                messagesList.innerHTML = ''
                //En esta parte del código, creamos un elemento de lista por cada mensaje que obtuvimos de la API
                messages.forEach(message => {
                    const messageItem = document.createElement('li')
                    messageItem.append(`${message.username}: ${message.message}`)
                    messagesList.append(messageItem)
                })

            }

            //Esta función nos ayudará a actualizar los mensajes cada cierto tiempo
            const update = async (getFunction, interval) =>{
                const execute = async () =>{
                    await getFunction()
                    setTimeout(execute, interval)
                }
                execute()

            }
            //Este método nos ayudará a enviar mensajes a la API
            const postMessage = async (username, message) =>{
                const response = await fetch('https://chat.tiburoncin.lat/messages', {
                    method: 'post',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        message: message
                    })
                })
                const data = await response.json()
                console.log(data)
            }

            let alertCond = false //Esta variable nos ayudará a verificar si el usuario ingreso un nombre de usuario no valido
            // Creación del campo de texto para el nombre de usuario
            const userField = document.createElement('textarea')
            userField.placeholder = 'Ingresa tu nombre de usuario: '
            userField.style.position = 'fixed';
            userField.style.top = '20%'
            userField.style.left = '50%'
            userField.style.transform = 'translateX(-50%)';
            document.body.append(userField)

            // Creación del botón "Continuar"
            const continueButton = document.createElement('button');
            continueButton.append('Continuar')
            continueButton.style.position = 'fixed'
            continueButton.style.top = '30%'
            continueButton.style.left = '50%'
            continueButton.style.transform = 'translateX(-50%)';
            document.body.append(continueButton)

            // Creación del área de mensaje
            const messageArea = document.createElement('textarea')
            messageArea.placeholder = 'Escribe tu mensaje'
            messageArea.style.position = 'fixed'
            messageArea.style.bottom = '70px'
            messageArea.style.left = '50%'
            messageArea.style.transform = 'translateX(-50%)'
            messageArea.style.width = '80%'


            // Creación del botón de enviar mensaje
            const messageButton = document.createElement('button')
            messageButton.append('Enviar');
            messageButton.style.position = 'fixed';
            messageButton.style.bottom = '10px';
            messageButton.style.left = '50%';
            messageButton.style.transform = 'translateX(-50%)';
            messageButton.style.width = '80px';

            //Creación del botón que nos ayuda a enviar imagenes
            const imageButton = document.createElement('input')
            imageButton.type = 'file'
            imageButton.append('Imagen')
            imageButton.style.position = 'fixed'
            imageButton.style.bottom = '10px'
            imageButton.style.left = '20%'
            imageButton.style.transform = 'translateX(-50%)'
            imageButton.style.width = '80px'

            // Event listener para el botón "Continuar"
            continueButton.addEventListener('click', () => {

            

                // Verificar si se ingresó un nombre de usuario válido
                if(userField.value === '') {
                    const alert = document.createElement('h1')
                    alert.append('Por favor ingresa un nombre de usuario válido')
                    alert.style.position = 'fixed'
                    alert.style.top = '40%'
                    alert.style.left = '50%'
                    alert.style.transform = 'translateX(-50%)'
                    alert.style.color = 'red'
                    document.body.append(alert)
                    alertCond = true
                }
                else{
                    if (alertCond){
                        document.body.removeChild(document.querySelector('h1'))
                    }
                    //Si el usuario ingresó un nombre valido, eliminamos los campos de registro de usuario y creamos botones pra enviar mensajes
                    
                    document.body.removeChild(userField)
                    document.body.removeChild(continueButton)
                    document.body.append(messageArea)
                    document.body.append(messageButton)
                    document.body.append(imageButton)
                    document.body.append(messagesList)
                    update(getMessages, 5000)
                    user = userField.value;
                    

                }

            })

            // Event listener para el botón de enviar mensaje
            messageButton.addEventListener('click', () => {

                if (messageArea.value === ''  ||  messageArea.value.lenght > 140){
                    
                }
                else{

                    postMessage(user, messageArea.value)
                    messageArea.value = ''
                }
                

            })
            messageArea.addEventListener('enter', () => {
                message = messageArea.value;
                postMessage(user, message)
                messageArea.value = ''
            })

            
            
        </script>
    </body>
</html>
